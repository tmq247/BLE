name: Build BLE-M3 ARM64

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld

      - name: Download Android NDK
        run: |
          NDK_VERSION=r25b
          wget https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip android-ndk-${NDK_VERSION}-linux.zip
          export ANDROID_NDK_HOME=$PWD/android-ndk-${NDK_VERSION}
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: Build BLE-M3
        run: |
          API=24
          clang --target=aarch64-linux-android${API} \
            --sysroot=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
            -D__ANDROID_API__=$API \
            -fPIE -pie -O2 \
            BLE-M3.c -o BLE-M3

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: BLE-M3-binary
          path: BLE-M3
